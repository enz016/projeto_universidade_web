<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Calendário Acadêmico</title>
    <link rel="stylesheet" href="css/style.css" />

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #eef2ff;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        /* AUMENTANDO O CALENDÁRIO */
        .calendar-container {
            width: 90%;
            max-width: 950px;
            margin: auto;
            background: white;
            padding: 25px 30px;
            border-radius: 14px;
            box-shadow: 0px 2px 10px rgba(0,0,0,0.15);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 22px;
            font-weight: bold;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            text-align: center;
        }

        .calendar-grid div {
            padding: 10px 0;
        }

        .day-header {
            font-weight: bold;
            background: #d2d8ff;
            border-radius: 5px;
        }

        .day {
            background: #f7f7f7;
            border-radius: 8px;
            min-height: 70px;
            cursor: pointer;
            position: relative;
            transition: 0.2s;
        }

        .day:hover {
            background: #e4e4e4;
        }

        .today {
            background: #7c8cff !important;
            color: white;
            font-weight: bold;
        }

        /* BOLINHAS DE EVENTOS */
        .dot-row {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .event-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* BOTÕES */
        .menu-button1 {
            display: inline-block;
            margin-bottom: 10px;
            padding: 10px 14px;
            background: white;
            border: 2px solid #4a4aff;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: 0.2s;
        }

        .menu-button1:hover {
            background: #dcdcff;
        }

        /* POP-UP */
        #eventoPopup,
        #listaEventosPopup {
            display:none;
            position: fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,0.6);
            align-items:center;
            justify-content:center;
            z-index: 999;
        }

        .popup-box {
            background:white;
            padding:20px;
            width:350px;
            border-radius:10px;
        }

        /* TOOLTIP */
        #tooltip {
            position: fixed;
            background:white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            display: none;
            box-shadow: 0px 2px 8px rgba(0,0,0,0.2);
            font-size: 13px;
            max-width: 250px;
            z-index: 2000;
        }
    </style>
</head>

<body>
    <a href="/" class="menu-button" style="margin-bottom: 20px; display:inline-block;">
    ⬅ Voltar para o sistema
</a>

    <h1>Calendário Acadêmico</h1>

    <button id="btnAddEvento" class="menu-button1">Adicionar Evento</button>
    <button id="btnGerenciarEventos" class="menu-button1">Gerenciar Eventos</button>

    <!-- POP-UP CADASTRO -->
    <div id="eventoPopup">
        <div class="popup-box">
            <h3>Cadastrar Evento</h3>
            
            <label>Data:</label>
            <input type="date" id="eventoData" style="width:100%; margin-bottom:10px;">

            <label>Tipo:</label>
            <select id="eventoTipo" style="width:100%; margin-bottom:10px;">
                <option value="Prova">Prova</option>
                <option value="Reunião">Reunião</option>
                <option value="Feriado">Feriado</option>
                <option value="Atividade">Atividade</option>
            </select>

            <label>Cor:</label>
            <input type="color" id="eventoCor" value="#00b894" style="width:100%; margin-bottom:10px;">

            <label>Descrição (opcional):</label>
            <input type="text" id="eventoDescricao" style="width:100%; margin-bottom:10px;">

            <button id="salvarEvento" style="margin-right:10px;">Salvar</button>
            <button id="cancelarEvento">Cancelar</button>
        </div>
    </div>

    <!-- LISTAGEM -->
    <div id="listaEventosPopup">
        <div class="popup-box" style="max-height:80%; overflow:auto;">
            <h3>Eventos cadastrados</h3>
            <div id="listaEventosContainer"></div>
            <button id="fecharListaEventos" style="margin-top:10px;">Fechar</button>
        </div>
    </div>

    <!-- CALENDÁRIO -->
    <div class="calendar-container">
        <div class="calendar-header">
            <span id="prev">◀</span>
            <span id="month-label"></span>
            <span id="next">▶</span>
        </div>

        <div class="calendar-grid" id="calendar"></div>
    </div>

    <!-- TOOLTIP -->
    <div id="tooltip"></div>

<script>

    const calendar = document.getElementById('calendar');
    const monthLabel = document.getElementById('month-label');

    const popup = document.getElementById('eventoPopup');
    const listaPopup = document.getElementById("listaEventosPopup");
    const tooltip = document.getElementById("tooltip");

    const eventoData = document.getElementById('eventoData');
    const eventoTipo = document.getElementById('eventoTipo');
    const eventoCor = document.getElementById('eventoCor');
    const eventoDescricao = document.getElementById('eventoDescricao');

    let currentDate = new Date();

    // BANCO
    let events = JSON.parse(localStorage.getItem("calendario_eventos") || "{}");

    function saveEvents() {
        localStorage.setItem("calendario_eventos", JSON.stringify(events));
    }

    function openPopup() {
        popup.style.display = "flex";
        eventoData.value = "";
        eventoDescricao.value = "";
        eventoTipo.value = "Prova";
        eventoCor.value = "#00b894";
    }

    function closePopup() {
        popup.style.display = "none";
    }

    function renderCalendar() {

        calendar.innerHTML = "";

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        monthLabel.textContent = currentDate.toLocaleString("pt-BR", {
            month: "long",
            year: "numeric"
        });

        const firstDay = new Date(year, month, 1).getDay();
        const totalDays = new Date(year, month + 1, 0).getDate();

        const weekdays = ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"];

        weekdays.forEach(day => {
            const div = document.createElement("div");
            div.classList.add("day-header");
            div.innerText = day;
            calendar.appendChild(div);
        });

        for (let i = 0; i < firstDay; i++) {
            calendar.appendChild(document.createElement("div"));
        }

        for (let day = 1; day <= totalDays; day++) {

            const div = document.createElement("div");
            div.classList.add("day");
            div.innerHTML = `<strong>${day}</strong>`;

            const today = new Date();
            if (
                day === today.getDate() &&
                month === today.getMonth() &&
                year === today.getFullYear()
            ) {
                div.classList.add("today");
            }

            const key = `${year}-${month + 1}-${day}`;

            // BOLINHAS DE EVENTOS
            if (events[key]) {
                const dots = events[key]
                    .slice(0, 4)
                    .map(ev => `<div class="event-dot" style="background:${ev.cor}"></div>`)
                    .join("");

                div.innerHTML += `<div class="dot-row">${dots}</div>`;
            }

            // CLICAR - já abre popup com a data preenchida
            div.addEventListener("click", () => {
                popup.style.display = "flex";
                eventoDescricao.value = "";
                eventoTipo.value = "Prova";
                eventoCor.value = "#00b894";
                
                // Preenche a data DEPOIS de abrir o popup
                const mes = String(month + 1).padStart(2, '0');
                const dia = String(day).padStart(2, '0');
                eventoData.value = `${year}-${mes}-${dia}`;
            });

            // TOOLTIP HOVER
            div.addEventListener("mouseenter", (e) => showTooltip(e, key));
            div.addEventListener("mouseleave", hideTooltip);

            calendar.appendChild(div);
        }
    }

    // NAVEGAÇÃO
    document.getElementById('prev').addEventListener("click", () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });

    document.getElementById('next').addEventListener("click", () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    // BOTÃO CADASTRO
    document.getElementById("btnAddEvento").addEventListener("click", openPopup);

    // SALVAR
    document.getElementById("salvarEvento").addEventListener("click", () => {
        // CORREÇÃO: usar split para evitar problema de fuso horário
        const [ano, mes, dia] = eventoData.value.split('-');
        const key = `${ano}-${parseInt(mes)}-${parseInt(dia)}`;

        if (!events[key]) events[key] = [];

        events[key].push({
            tipo: eventoTipo.value,
            descricao: eventoDescricao.value,
            cor: eventoCor.value
        });

        saveEvents();
        closePopup();
        renderCalendar();
    });

    // CANCELAR
    document.getElementById("cancelarEvento").addEventListener("click", closePopup);

    // MOSTRAR LISTAGEM
    document.getElementById("btnGerenciarEventos").addEventListener("click", abrirListaEventos);

    function abrirListaEventos() {

        const container = document.getElementById("listaEventosContainer");
        container.innerHTML = "";

        const chaves = Object.keys(events);

        if (chaves.length === 0) {
            container.innerHTML = "<p>Nenhum evento cadastrado.</p>";
        } else {

            chaves.forEach((key) => {

                events[key].forEach((ev, index) => {

                    const linha = document.createElement("div");
                    linha.style = `
                        margin-bottom: 12px;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                    `;

                    linha.innerHTML = `
                        <b>Data:</b> ${key}<br>
                        <b>Tipo:</b> ${ev.tipo}<br>
                        <b>Descrição:</b> ${ev.descricao || "(sem descrição)"}<br>
                        <br>
                        <button class="editarEvento" data-key="${key}" data-index="${index}">Editar</button>
                        <button class="excluirEvento" data-key="${key}" data-index="${index}" style="margin-left:8px; color:red;">
                            Excluir
                        </button>
                    `;

                    container.appendChild(linha);
                });
            });
        }

        listaPopup.style.display = "flex";
    }

    document.getElementById("fecharListaEventos").addEventListener("click", () => {
        listaPopup.style.display = "none";
    });

    // EXCLUIR
    document.addEventListener("click", (e) => {

        if (!e.target.classList.contains("excluirEvento")) return;

        const key = e.target.getAttribute("data-key");
        const index = e.target.getAttribute("data-index");

        events[key].splice(index, 1);

        if (events[key].length === 0) delete events[key];

        saveEvents();
        renderCalendar();
        abrirListaEventos();
    });

    // EDITAR
    document.addEventListener("click", (e) => {

        if (!e.target.classList.contains("editarEvento")) return;

        const key = e.target.getAttribute("data-key");
        const index = e.target.getAttribute("data-index");
        const ev = events[key][index];

        // CORREÇÃO: criar data correta para edição
        const [ano, mes, dia] = key.split('-');
        const mesFormatado = String(mes).padStart(2, '0');
        const diaFormatado = String(dia).padStart(2, '0');
        eventoData.value = `${ano}-${mesFormatado}-${diaFormatado}`;
        
        eventoTipo.value = ev.tipo;
        eventoDescricao.value = ev.descricao;
        eventoCor.value = ev.cor;

        listaPopup.style.display = "none";
        popup.style.display = "flex";

        // Quando salvar, ele sobrescreve automaticamente pelo push
    });

    // TOOLTIP
    function showTooltip(ev, key) {

        if (!events[key]) return;

        tooltip.innerHTML = events[key]
            .map(e => `
                <div style="margin-bottom:4px;">
                    <div style="
                        width: 10px;
                        height: 10px;
                        background:${e.cor};
                        border-radius:50%;
                        display:inline-block;
                        margin-right:5px;
                    "></div>
                    <b>${e.tipo}</b><br>
                    <span>${e.descricao}</span>
                </div>
            `)
            .join("");

        tooltip.style.left = ev.pageX + 15 + "px";
        tooltip.style.top = ev.pageY + 15 + "px";
        tooltip.style.display = "block";
    }

    function hideTooltip() {
        tooltip.style.display = "none";
    }

    renderCalendar();

</script>

</body>
</html>